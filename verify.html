<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.skr Verify</title>
  <link rel="stylesheet" href="src/css/fonts.css">
  <link rel="stylesheet" href="src/css/base.css">
  <link rel="stylesheet" href="src/css/components.css">
  <style>
    html, body {
      height: auto;
      overflow-y: auto;
    }
    body {
      background: var(--bg-core);
      color: var(--color-text);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    .verify-shell {
      width: min(880px, 92vw);
      background: var(--bg-panel);
      border: 2px solid var(--color-accent-dim);
      border-radius: calc(var(--radius) + 2px);
      box-shadow: none;
      padding: 28px 22px 32px;
      position: relative;
      background-image:
        repeating-linear-gradient(30deg, rgba(0,0,0,0.04) 0 1px, transparent 1px 22px),
        repeating-linear-gradient(150deg, rgba(0,0,0,0.03) 0 1px, transparent 1px 22px);
      background-size: auto;
    }
    .verify-shell::before {
      content: "";
      position: absolute;
      inset: 10px;
      border: 1px solid var(--color-accent-dim);
      border-radius: var(--radius);
      pointer-events: none;
      opacity: 0.6;
    }
    .verify-shell::after {
      content: "";
      position: absolute;
      top: 18px;
      right: 18px;
      font-size: 18px;
      letter-spacing: 1px;
      color: var(--color-muted);
      opacity: 0.6;
      pointer-events: none;
    }
    .verify-header {
      text-align: left;
      padding-bottom: 20px;
      border-bottom: var(--border-style);
      display: grid;
      gap: 6px;
    }
    .verify-title {
      margin: 0 0 6px;
      font-size: 26px;
      line-height: 1.2;
      letter-spacing: 0.2px;
      font-family: "Source Serif 4", "Georgia", "Times New Roman", serif;
      font-weight: 600;
    }
    .verify-subtitle {
      margin: 0;
      font-size: 13px;
      color: var(--color-muted);
      letter-spacing: 0.2px;
      text-transform: none;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .verify-mark {
      font-size: 11px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--color-muted);
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .verify-body {
      padding: 18px 0;
      display: grid;
      gap: 18px;
      font-size: 15px;
      line-height: 1.75;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .verify-body p { margin: 0; }
    .verify-body p strong { color: var(--color-text); font-weight: 600; }
    .verify-note {
      color: var(--color-muted);
      font-size: 12px;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    }
    .verify-drop {
      border: var(--border-style);
      border-radius: var(--radius);
      padding: 18px 20px;
      text-align: left;
      background: var(--xray-surface);
      display: grid;
      gap: 10px;
    }
    .verify-drop strong {
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--color-muted);
    }
    .verify-drop input[type=file] {
      display: none;
    }
    .btn-full {
      padding: 10px 14px;
      border-radius: var(--radius);
      border: var(--border-style);
      background: var(--color-accent);
      color: var(--bg-core);
      font-size: 12px;
      letter-spacing: 0.4px;
      cursor: pointer;
    }
    .btn-ghost {
      padding: 10px 14px;
      border-radius: var(--radius);
      border: var(--border-style);
      background: transparent;
      color: var(--color-text);
      font-size: 12px;
      letter-spacing: 1px;
      cursor: pointer;
    }
    .verify-actions {
      display: flex;
      justify-content: flex-start;
      gap: 12px;
    }
    .verify-result {
      border-top: var(--border-style);
      padding-top: 16px;
      display: grid;
      gap: 8px;
    }
    .verify-result h3,
    .verify-result-title {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--color-muted);
    }
    .verify-status {
      display: grid;
      gap: 6px;
      font-size: 13px;
    }
    .verify-status .ok { color: #6faf86; }
    .verify-status .warn { color: var(--color-muted); }
    .verify-metrics {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: var(--color-muted);
    }
    .verify-metrics .row {
      display: grid;
      gap: 12px;
      grid-template-columns: minmax(220px, 1fr) minmax(220px, 1.2fr);
      align-items: center;
    }
    .verify-metrics .label {
      color: var(--color-muted);
      text-align: right;
    }
    .verify-metrics .value {
      color: var(--color-text);
      font-variant-numeric: tabular-nums;
      cursor: pointer;
      text-align: left;
    }
    .verify-metrics .value.copied {
      color: var(--color-accent);
    }
    .verify-metrics .value.copied::after {
      content: "Copiado";
      margin-left: 8px;
      font-size: 11px;
      color: var(--color-muted);
    }
    .verify-footer {
      margin-top: 16px;
      padding-top: 16px;
      border-top: var(--border-style);
      text-align: left;
      font-size: 12px;
      color: var(--color-muted);
      line-height: 1.6;
    }
    .verify-faq {
      border-top: var(--border-style);
      padding-top: 16px;
      display: grid;
      gap: 14px;
    }
    .verify-faq h3 {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--color-muted);
    }
    .verify-faq-summary {
      margin: 0;
      font-size: 13px;
      line-height: 1.6;
      color: var(--color-muted);
    }
    .verify-faq-actions {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .verify-faq-actions .verify-note { margin: 0; }
    .verify-faq-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
    }
    .verify-faq-links a {
      color: var(--color-accent);
      text-decoration: none;
      border-bottom: 1px solid var(--color-accent-dim);
    }
    .verify-faq-item {
      display: grid;
      gap: 6px;
      font-size: 13px;
      line-height: 1.6;
    }
    .verify-faq-item h4 {
      margin: 0;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: var(--color-text);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .verify-faq-item h4 .icon {
      width: 16px;
      height: 16px;
      color: var(--color-muted);
      flex: 0 0 auto;
    }
    .verify-faq-item p {
      margin: 0;
      color: var(--color-muted);
    }
    .verify-faq-item ul {
      margin: 0;
      padding-left: 16px;
      color: var(--color-muted);
    }
    .verify-faq-item li { margin-bottom: 6px; }
    @media (max-width: 720px) {
      body { padding: 12px; }
      .verify-shell {
        width: 100%;
        max-width: 100%;
        padding: 20px 16px 24px;
        box-sizing: border-box;
      }
      .verify-shell::before { inset: 6px; }
      .verify-title { font-size: 22px; }
      .verify-body { font-size: 14px; }
      .verify-metrics .row {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .verify-metrics .label { text-align: left; }
    }
    @media (max-width: 1100px) {
      body { padding: 16px; }
      .verify-shell {
        width: min(760px, 96vw);
        max-width: 96vw;
        padding: 22px 18px 28px;
        box-sizing: border-box;
      }
      .verify-shell::before { inset: 8px; }
    }
  </style>
</head>
<body>
  <div class="verify-shell">
    <div class="verify-header">
      <h1 class="verify-title">.skr Verify</h1>
      <p class="verify-subtitle">eskrev · Verificação técnica de escrita humana</p>
      <div class="verify-mark">Relatório técnico</div>
    </div>

    <div class="verify-body">
      <p>Verifique a integridade técnica de um arquivo .skr.</p>
      <p class="verify-note">Não é análise de estilo. Não é detecção de IA.</p>
      <p>É verificação técnica do processo.</p>

      <div class="verify-drop" id="dropZone">
        <strong>Envie seu arquivo .skr</strong>
        <div>Arraste o arquivo .skr</div>
        <div>ou</div>
        <label class="btn-full" for="fileInput">Selecionar arquivo</label>
        <input id="fileInput" type="file" accept=".skr,application/json">
      </div>

      <div class="verify-result" id="verifyResult">
        <h3 class="verify-result-title">Resultado · O que é registrado</h3>
        <div class="verify-status" id="verifyStatus">
          <div class="warn">Nenhum arquivo carregado.</div>
        </div>
        <div class="verify-metrics" id="verifyMetrics">
          <div class="row"><span class="label">Hash criptográfico do texto final</span><span class="value" id="metricHash" title="">—</span></div>
          <div class="row"><span class="label">Duração da sessão</span><span class="value" id="metricDuration">—</span></div>
          <div class="row"><span class="label">Eventos de digitação</span><span class="value" id="metricEvents">—</span></div>
          <div class="row"><span class="label">Ritmo e pausas</span><span class="value" id="metricPauses">—</span></div>
          <div class="row"><span class="label">Sequência temporal do processo</span><span class="value" id="metricSequence">—</span></div>
        </div>
        <p class="verify-note">Este relatório descreve dados técnicos. A interpretação cabe a quem avalia.</p>
      </div>

      <div class="verify-footer">
        <div>Nenhum dado é enviado ou armazenado.</div>
      </div>

      <div class="verify-faq">
        <h3>Guia rápido para editoras e avaliadores</h3>
        <p class="verify-faq-summary">Resumo curto: o Verify confirma a integridade técnica de um arquivo .skr e descreve o processo de escrita.</p>
        <div class="verify-faq-actions">
          <button id="btnFaqPdf" class="btn-ghost">Baixar resumo PDF</button>
          <span class="verify-note">A impressão abre para salvar em PDF.</span>
        </div>
        <div class="verify-faq-links">
          <a href="#faq-o-que-e">O que é</a>
          <a href="#faq-o-que-registra">O que registra</a>
          <a href="#faq-o-que-faz">O que verifica</a>
          <a href="#faq-nao-faz">O que não faz</a>
          <a href="#faq-interpretacao">Como interpretar</a>
          <a href="#faq-por-que">Por que importa</a>
        </div>

        <div class="verify-faq-item" id="faq-o-que-e">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-notepad"></use></svg>O que é o Verify?</h4>
          <p>Ferramenta técnica para verificar produção por digitação humana neste ambiente.</p>
        </div>

        <div class="verify-faq-item" id="faq-o-que-registra">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-file-text"></use></svg>O que é registrado durante a escrita?</h4>
          <p>Hash do texto, duração da sessão, eventos de digitação, ritmo de pausas e sequência temporal.</p>
        </div>

        <div class="verify-faq-item" id="faq-o-que-faz">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-book-open-text"></use></svg>O que o Verify faz?</h4>
          <p>Carrega um arquivo .skr, recalcula o hash, compara com o registro e apresenta um relatório técnico do processo.</p>
        </div>

        <div class="verify-faq-item" id="faq-nao-faz">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-warning"></use></svg>O que o Verify não faz?</h4>
          <p>Não certifica autoria legal, não garante exclusividade intelectual e não analisa estilo literário.</p>
        </div>

        <div class="verify-faq-item" id="faq-interpretacao">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-eyeglasses"></use></svg>Como interpretar o relatório?</h4>
          <p>Como evidência técnica complementar, similar a logs de criação e históricos de versão. A decisão permanece humana.</p>
        </div>

        <div class="verify-faq-item" id="faq-por-que">
          <h4><svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><use href="src/assets/icons/phosphor-sprite.svg#icon-chat-circle-text"></use></svg>Por que isso importa hoje?</h4>
          <p>Em um cenário de geração automática, o processo de escrita (tempo, hesitação, revisão, ritmo) torna-se um dado relevante.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const applyTheme = (value) => {
      const theme = value || localStorage.getItem("lit_theme_pref") || "paper";
      document.body.setAttribute("data-theme", theme);
    };
    applyTheme();
    window.addEventListener("storage", (e) => {
      if (e.key === "lit_theme_pref") applyTheme(e.newValue);
    });
    window.addEventListener("message", (e) => {
      if (e.origin !== window.location.origin) return;
      if (e.data && e.data.type === "theme") applyTheme(e.data.value);
    });

    const fileInput = document.getElementById("fileInput");
    const verifyStatus = document.getElementById("verifyStatus");
    const metricHash = document.getElementById("metricHash");
    const metricDuration = document.getElementById("metricDuration");
    const metricEvents = document.getElementById("metricEvents");
    const metricPauses = document.getElementById("metricPauses");
    const metricSequence = document.getElementById("metricSequence");
    const bindCopy = (el, getValue) => {
      if (!el) return;
      el.addEventListener("click", async () => {
        const value = getValue();
        if (!value || value === "—") return;
        try {
          await navigator.clipboard.writeText(value);
          el.classList.add("copied");
          setTimeout(() => el.classList.remove("copied"), 900);
        } catch (_) {
          // ignore clipboard failures silently
        }
      });
    };
    const dropZone = document.getElementById("dropZone");
    let pendingText = "";

    const setStatus = (lines) => {
      verifyStatus.innerHTML = "";
      lines.forEach(({ text, type }) => {
        const row = document.createElement("div");
        row.className = type || "ok";
        row.textContent = text;
        verifyStatus.appendChild(row);
      });
    };

    const readFile = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsText(file);
      });
    };

    const sha256Hex = async (text) => {
      const data = new TextEncoder().encode(text);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    };

    const parseTot = (raw) => {
      const parsed = JSON.parse(raw);
      const contentText = parsed?.content?.text || parsed?.MASTER_TEXT || "";
      const proofHash = parsed?.proof?.content_hash || "";
      const keystrokes = parsed?.writing_process?.keystrokes_total || parsed?.HEADER?.KEYSTROKES || 0;
      return { parsed, contentText, proofHash, keystrokes };
    };

    const formatHash = (hash) => {
      if (!hash) return "—";
      if (hash.length <= 16) return hash;
      return `${hash.slice(0, 10)}…${hash.slice(-8)}`;
    };

    const formatDuration = (parsed) => {
      const mins = parsed?.session?.duration_minutes;
      if (Number.isFinite(mins) && mins > 0) return `${mins} min`;
      const started = parsed?.session?.started_at;
      const ended = parsed?.session?.ended_at;
      if (started && ended) {
        const diff = Math.max(0, new Date(ended) - new Date(started));
        const m = Math.round(diff / 60000);
        return m > 0 ? `${m} min` : "—";
      }
      return "—";
    };

    const formatEvents = (parsed) => {
      const ins = parsed?.writing_process?.insertions;
      const del = parsed?.writing_process?.deletions;
      const rev = parsed?.writing_process?.revisions;
      if ([ins, del, rev].some((v) => Number.isFinite(v))) {
        return `ins ${ins ?? 0} · del ${del ?? 0} · rev ${rev ?? 0}`;
      }
      return "—";
    };

    const formatPauses = (parsed) => {
      const pauses = parsed?.writing_process?.pause_profile;
      if (pauses && (pauses.short || pauses.medium || pauses.long)) {
        return `curtas ${pauses.short ?? 0} · médias ${pauses.medium ?? 0} · longas ${pauses.long ?? 0}`;
      }
      return "não informado";
    };

    const formatSequence = (parsed) => {
      const started = parsed?.session?.started_at;
      const ended = parsed?.session?.ended_at;
      if (started && ended) return `${started} → ${ended}`;
      return "—";
    };

    const verifyTot = async () => {
      if (!pendingText) return;
      try {
        const { parsed, contentText, proofHash, keystrokes } = parseTot(pendingText);
        const hash = await sha256Hex(contentText || "");
        const hashOk = proofHash && hash === proofHash;
        const humanOk = keystrokes > 0;

        const lines = [
          { text: hashOk ? "✔ Arquivo .skr íntegro" : "✖ Arquivo .skr inválido", type: hashOk ? "ok" : "warn" },
          { text: hashOk ? "✔ Texto confere com o hash" : "✖ Texto não confere com o hash", type: hashOk ? "ok" : "warn" },
          { text: humanOk ? "✔ Processo compatível com digitação humana" : "• Processo sem dados suficientes", type: humanOk ? "ok" : "warn" }
        ];
        setStatus(lines);
        const fullHash = hashOk ? proofHash : hash;
        metricHash.textContent = formatHash(fullHash);
        metricHash.title = fullHash || "";
        metricDuration.textContent = formatDuration(parsed);
        metricEvents.textContent = formatEvents(parsed);
        metricPauses.textContent = formatPauses(parsed);
        metricSequence.textContent = formatSequence(parsed);
      } catch (e) {
        setStatus([{ text: "✖ Falha ao ler o arquivo .skr", type: "warn" }]);
        metricHash.textContent = "—";
        metricHash.title = "";
        metricDuration.textContent = "—";
        metricEvents.textContent = "—";
        metricPauses.textContent = "—";
        metricSequence.textContent = "—";
      }
    };

    bindCopy(metricHash, () => metricHash.title);

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      pendingText = await readFile(file);
      await verifyTot();
    });

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.style.borderColor = "var(--color-accent)";
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.style.borderColor = "";
    });
    dropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      dropZone.style.borderColor = "";
      const file = e.dataTransfer.files[0];
      if (!file) return;
      pendingText = await readFile(file);
      await verifyTot();
    });

    const btnFaqPdf = document.getElementById("btnFaqPdf");
    const buildA4Html = () => `
      <!doctype html>
      <html lang="pt-BR">
        <head>
          <meta charset="UTF-8">
          <title>.skr Verify — Resumo A4</title>
          <style>
            @page { size: A4; margin: 28mm 24mm; }
            html, body { margin: 0; padding: 0; }
            body {
              font-family: "Inter", "Source Serif 4", "IBM Plex Sans", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
              color: #1f1f1f;
              font-size: 12.5pt;
              line-height: 1.6;
            }
            h1 { font-size: 15pt; margin: 0 0 10px; font-weight: 600; }
            p { margin: 10px 0; }
            ul { margin: 8px 0 12px 18px; }
            li { margin-bottom: 6px; }
            .title-row { display:flex; align-items:center; gap:10px; margin-bottom: 12px; }
            .logo { width: 16px; height: 16px; display:inline-block; }
            .logo svg { width: 100%; height: 100%; display:block; }
          </style>
        </head>
        <body>
          <div class="title-row">
            <span class="logo">
              <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" aria-label=".skr">
                <circle cx="16" cy="16" r="13" fill="none" stroke="#1f1f1f" stroke-width="2.5"/>
                <path d="M16 6 v20 M10 10 h12" stroke="#1f1f1f" stroke-width="2.5" fill="none" stroke-linecap="round"/>
              </svg>
            </span>
            <h1>.skr Verify — Resumo para editoras e avaliadores</h1>
          </div>
          <p>O .skr Verify confirma a integridade técnica de um arquivo .skr, recalculando o hash do texto e exibindo dados do processo de escrita. Não certifica autoria legal, não detecta IA e não julga qualidade literária. O relatório é evidência técnica complementar.</p>
          <p><strong>O que o .skr registra:</strong></p>
          <ul>
            <li>Hash criptográfico do texto final</li>
            <li>Duração da sessão</li>
            <li>Eventos de digitação (inserções, deleções, revisões)</li>
            <li>Ritmo e pausas</li>
            <li>Sequência temporal do processo</li>
          </ul>
          <p><strong>O que o Verify faz:</strong> carrega um arquivo .skr, recalcula o hash, compara com o registro e apresenta um relatório técnico do processo.</p>
          <p><strong>O que o Verify não faz:</strong> não certifica autoria legal, não garante exclusividade intelectual e não analisa estilo literário.</p>
          <p><strong>Como interpretar:</strong> evidência técnica complementar, similar a logs de criação e históricos de versão. A decisão permanece humana.</p>
        </body>
      </html>
    `;
    if (btnFaqPdf) {
      btnFaqPdf.addEventListener("click", () => {
        const html = buildA4Html();
        const iframe = document.createElement("iframe");
        iframe.style.position = "fixed";
        iframe.style.right = "0";
        iframe.style.bottom = "0";
        iframe.style.width = "0";
        iframe.style.height = "0";
        iframe.style.border = "0";
        iframe.style.opacity = "0";
        iframe.setAttribute("aria-hidden", "true");
        document.body.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(html);
        doc.close();
        const triggerPrint = () => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        };
        if (iframe.contentWindow.document.readyState === "complete") {
          triggerPrint();
        } else {
          iframe.onload = triggerPrint;
        }
        setTimeout(() => iframe.remove(), 1000);
      });
    }
  </script>
</body>
</html>
